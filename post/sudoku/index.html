<html lang="en">
<head>

  
  <meta charset="utf-8">
  <title>Using Go to Randomly Generate SudoKu</title>
  <meta name="description" content="Using Go to Randomly Generate SudoKu">
  <meta name="author" content="Shantanu Joshi">

  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="http://joshishantanu.com//css/fonts.css">
  <link rel="stylesheet" href="http://joshishantanu.com//css/normalize.css">
  <link rel="stylesheet" href="http://joshishantanu.com//css/skeleton.css">
  <link rel="stylesheet" href="http://joshishantanu.com//css/custom.css">

  
  
  <link rel="stylesheet" href="http://joshishantanu.com//highlight/styles/default.css">
  
  <script src="http://joshishantanu.com//highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

<header id="menu">
  <div class="container">
	<span class="logo">Shantanu Joshi</span>
	<a>&#9776;</a>
  </div>
</header>

<nav class="navbar">
  <div class="container">
	<div class="row">
	  <div class="eight columns offset-by-two">
		<ul class="">
		  
		  <li class="u-pull-left"> <a href="http://joshishantanu.com/" class="brand" style="font-weight:bold;font-size:normal"> Shantanu Joshi </a></li>
		  <li class="u-pull-right cate"> <a href="http://joshishantanu.com//about/" class=""> About </a></li>
		  
		</ul>
	  </div>
	</div>
  </div>
</nav>


<div class="container post-wrapper">
  <div class="row">
	<div class="eight columns offset-by-two">
	  <div id="post-title">
		<p class="footnote">
		  
		  <time class="">2016-01-23</time>
		  
		  
		  

		  

		  

		</p>
		<h5>Using Go to Randomly Generate SudoKu</h5>
	  </div>

	  <div class="post">
		

<p>I recently watched <a href="https://www.youtube.com/watch?v=SmoM1InWXr0">this</a> talk by John Graham-Cumming titled: <code>A Channel Compendium</code>. It has a lot of neat tricks like how to start all go-routines at the same time, how to kill all the go-routines instantly etc. I highly recommend watching it.</p>

<p>In order to play around with those techniques a bit more, I decided to come up with a problem that would require a lot of go-routines and channels to communicate and synchronize between them. Instead of solving a sudoku, I thought it would be fun to see if I could use some structured randomness to generate a valid Sudoku puzzle.</p>

<p>What do I mean by structured randomness ?</p>

<p>I played around with a few examples of <code>4x4</code> sudoku and came up with the following algorithm.</p>

<pre><code>1. Randomly generate a valid configuration for each sub-grid 
2. Fix All Rows to be valid 
3. Fix All columns 
4. if valid: end else goto: 2 
</code></pre>

<p>All steps except the last can be run concurrently, i:e we can fix all rows concurrently, fix all columns concurrently and even do the inital grid-configuration concurrently.</p>

<h2 id="details:631265fb7f18bbd4d4ad7d6f9c0f348e">Details</h2>

<p>After <code>Step 1</code> in the above algorithm, the rows and columns may be messed up and need to be fixed. I decided to fix them in the following manner:</p>

<ul>
<li>For a row: if a number <code>d</code> is repeated more than once, keep its <code>first</code> instance and replace the rest with the missing numbers ( randomly)</li>
<li>For a col: if a number <code>D</code> is repeated more than once, keep its <code>last</code> instance and replace the rest with the missing numbers ( randomly )</li>
</ul>

<p>This is required so that <code>fixCol</code> does not undo a change made by <code>fixRow</code> and then we would be stuck in an infinite loop</p>

<p>By this point, however, I had realized that one of my objectives would not be met, there is no need for synchronization here, as each row,column and sub-grid is totally independent of the other and hence there is no use of channels here. Having spent some time manually trying out a couple of examples, I decided to follow through with the project in any case.</p>

<p>The astute reader, might have realized that I&rsquo;ve made a very big assumption here: There&rsquo;s no guaratee that the above algorithm converges at all. Having tried out a lot of examples, I conjectured, that it would work for atleast <code>n=4</code>.</p>

<h2 id="implementaiton:631265fb7f18bbd4d4ad7d6f9c0f348e">Implementaiton</h2>

<p>The main issue, I ran into is: waiting for all <code>go-routines</code> from a previous step ( say step1 ) to finish before I started all the go-routines in step 2.</p>

<p>Turns out this is a common enough problem with well documented solutions in Stackoverflow and the go-lang mailing list.</p>

<p>Here&rsquo;s some code to illustrate the point:</p>

<pre><code class="language-go">type SudoKu struct {
  n int // puzzle size 
  board [][]int // board 
}

var wg sync.WaitGroup 
for i := 0; i &lt; s.n; i++ {
     wg.Add(1)
     go func(index int) {
         defer wg.Done()
         s.PopulateSquare(index)
       }(i)
     }
     wg.Wait()&gt;
</code></pre>

<p><code>PopulateSquare</code> is a method on <code>s</code> which is an instance of a struct of type <code>SudoKu</code>. The method takes as argument an index which maps to the sub-grid to be randomly populated. In order to do this concurrently, we wrap <code>PopulateSquare</code> in a <code>go-routine</code>.</p>

<p>The <code>waitGroup</code> keeps track of how many go-routines it has to wait for ( via <code>wg.Add</code> ). The <code>Wait</code> function waits for the number of go-routines that it has to wait for to be <code>0</code>. When a go-routine is done, it should call <code>wg.Done</code> so that the counter can be reduced. I really liked this approach, because, it means I can first write and test my function as if it were running serially, and witha simple 3 line change immediately have it run as a go-routine without modifying any of my tests. Additionally, all the bookkeeping code for the waitGroup, is close together and easy to understand. (Initally, I was passing the wg as an argument to <code>PopulateSquare</code> )</p>

<p>A similar approach works for <code>FixRows and FixCol</code></p>

<pre><code class="language-go"> func (s * Sudoku) FixCols(flag bool) {
    for i := 0; i &lt; s.n; i++ {
      wg.Add(1)
      go func(index int) {
        defer wg.Done()
        s.fixCol(index, flag)
      }(i)
    }
    wg.Wait()
  }
</code></pre>

<p>A common gotcha here is to <code>not</code> pass the loop-counter as an argument to the go-routine, but use it diretly, inside. This creates a race-condition and most often all go-routines will use the same value of the loop-counter ( the last value before it exits the loop )</p>

<h2 id="results:631265fb7f18bbd4d4ad7d6f9c0f348e">Results</h2>

<p>After a couple of successfull trials on <code>4x4</code> I ran into a puzzle every few times that would go into an infinite loop. Digging into one such example, I saw the following:</p>

<pre><code class="language-python"># Inital Board 
[1 4 1 2]
[3 2 4 3]
[1 2 4 2]
[4 3 3 1]
# fixRow 
[1 4 3 2]
[3 2 4 1]
[1 2 4 3]
[4 3 2 1]
# fixCol 
[2 4 3 2]
[3 1 1 4]
[1 2 4 3]
[4 3 2 1]
# fixRow 
[2 4 3 1]
[3 1 2 4]
[1 2 4 3]
[4 3 2 1]
# fixCol
[2 4 3 2]
[3 1 1 4]
[1 2 4 3]
[4 3 2 1]
.
.
.
</code></pre>

<p>The solution: reduce some structure and make it more random.  Here&rsquo;s the modification I made:</p>

<ul>
<li>Insted of always keeping the first instance of a repeated number <code>d</code> in a row and the last instance in a column, I alternated it.</li>
<li>For iteration 0: fixRows and fixCols behave as described previously but</li>
<li>For iteration 1: fixRows keeps the last repeated instance of <code>d</code> and fixCol keeps the first repeated instance.</li>
</ul>

<p>This broke the cycle and the program now works reliably for <code>n=4</code></p>

<p>The problem space no <code>n=9</code> is too large for this program to converge in a reasonable amount of time.</p>

<p>You can find the code on <a href="https://github.com/joshi4/sudokugen">Github</a></p>

	  </div>
	</div>
  </div>
</div>

<div class="footer">
  <div class="container">
	<div class="row">
	  <div class="ten columns offset-by-two">
		<p class="footnote">
		  
		  (c) Shantanu Joshi 2015. Powered by hugo and theme is nofancy
		  
		  
		  Find me at

		  
		  <a href="https://github.com/joshi4" >GitHub</a>
		  

		  

		  

		  

		  
		</p>
	  </div>
	</div>
  </div>
</div>


<script src="http://joshishantanu.com//js/jquery.min.js" type="text/javascript"></script>
<script src="http://joshishantanu.com//js/jquery.timeago.js" type="text/javascript"></script>
<script type="text/javascript">
  $(function(){
    $("time.timeago").timeago();
  })
  $("#menu").click(function(){
    $(".brand").text("HOME");
    $(".navbar ul li").removeClass("cate");
    $(".navbar").toggle();
  });
  $(window).resize(function(){
    if(window.innerWidth > 768) {
      $(".navbar").removeAttr("style");
    }
  });
</script>

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</body>
</html>

